<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Centennial ‚Äì South Conference Room</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      color: #fff;
      background: #000;
      overflow: hidden;
    }

    .background {
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      z-index: -1;
    }

    header {
      position: absolute;
      top: 20px;
      left: 30px;
      font-size: 1.6rem;
      font-weight: 600;
      color: #00539f;
      text-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    #logo {
      position: absolute;
      top: 20px;
      right: 30px;
      max-width: 160px;
      height: auto;
      opacity: 0.95;
    }

    .clock-container {
      position: absolute;
      top: 80px;
      left: 30px;
    }

    .clock {
      font-size: 3.8rem;
      font-weight: bold;
    }

    .date {
      font-size: 1.2rem;
      color: #f7b500;
      margin-top: 5px;
    }

    #status {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: 500;
    }

    #status.available {
      color: #00c853;
    }

    #status.busy {
      color: #e53935;
    }

    .weather {
      position: absolute;
      bottom: 30px;
      left: 30px;
      font-size: 1rem;
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }

    .temp {
      font-size: 1.8rem;
      font-weight: 600;
    }

    .forecast {
      display: flex;
      gap: 14px;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    .forecast div {
      text-align: center;
    }
  </style>
</head>
<body>

<div class="background" id="bg"></div>

<header>Centennial ‚Äì South Conference Room</header>
<img id="logo" src="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha" alt="Plumbline Logo"/>

<div class="clock-container">
  <div class="clock" id="clock">--:--</div>
  <div class="date" id="date">Loading...</div>
  <div id="status">Loading schedule...</div>
</div>

<div class="weather" id="weather">
  <div class="temp" id="temp">--¬∞F</div>
  <div id="conditions"></div>
  <div class="forecast" id="forecast"></div>
</div>

<script>
/* --- CONFIG --- */
const IMAGE = "images/calphoto1.jpg";
const ICS_URL = "https://ics-proxy.vercel.app/?url=" + encodeURIComponent(
  "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/e8f33aaadcfb49e5b0a03df0bdb5e2c58129590484901015770/calendar.ics"
);
const LAT = 39.5807, LON = -104.8772;

/* --- BACKGROUND --- */
document.getElementById("bg").style.backgroundImage = `url('${IMAGE}')`;

/* --- CLOCK --- */
function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  document.getElementById("date").textContent = now.toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric'});
}
setInterval(updateClock, 1000);
updateClock();

/* --- WEATHER --- */
async function loadWeather() {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&temperature_unit=fahrenheit&current=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&forecast_days=4&timezone=auto`;
    const res = await fetch(url);
    const data = await res.json();
    const codes = {0:"‚òÄÔ∏è",1:"üå§",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´",48:"üå´",51:"üå¶",61:"üåß",71:"‚ùÑÔ∏è",80:"üåß",95:"‚õà"};
    document.getElementById("temp").textContent = `${Math.round(data.current.temperature_2m)}¬∞F`;
    document.getElementById("conditions").textContent = codes[data.current.weathercode] || "";
    const fc = document.getElementById("forecast");
    fc.innerHTML = "";
    for (let i = 1; i < data.daily.time.length; i++) {
      const d = new Date(data.daily.time[i]);
      fc.innerHTML += `<div>${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]}<br>${codes[data.daily.weathercode[i]]||""}<br><small>${Math.round(data.daily.temperature_2m_max[i])}¬∞/${Math.round(data.daily.temperature_2m_min[i])}¬∞</small></div>`;
    }
  } catch (e) {
    console.error("Weather error", e);
  }
}
loadWeather();
setInterval(loadWeather, 1800000);

/* --- CALENDAR STATUS --- */
async function loadICS() {
  try {
    const res = await fetch(ICS_URL);
    const text = await res.text();
    const unfolded = text.replace(/\r?\n[ \t]/g, "");
    const lines = unfolded.split(/\r?\n/);
    const events = [];
    let current = {};
    for (const line of lines) {
      if (line.startsWith("BEGIN:VEVENT")) current = {};
      else if (line.startsWith("SUMMARY:")) current.summary = line.slice(8).trim();
      else if (line.startsWith("DTSTART")) current.start = parseDate(line);
      else if (line.startsWith("DTEND")) current.end = parseDate(line);
      else if (line.startsWith("END:VEVENT")) events.push(current);
    }
    updateStatus(events);
  } catch (e) {
    document.getElementById("status").textContent = "Unable to load calendar";
    console.error("ICS Load Error", e);
  }
}

function parseDate(line) {
  const match = line.match(/(\d{8}T\d{6})(Z)?$/);
  if (!match) return null;
  const dateStr = match[1], isUtc = !!match[2];
  const year = dateStr.substr(0,4), mon = dateStr.substr(4,2), day = dateStr.substr(6,2);
  const hour = dateStr.substr(9,2), min = dateStr.substr(11,2), sec = dateStr.substr(13,2);
  const iso = `${year}-${mon}-${day}T${hour}:${min}:${sec}${isUtc?"Z":""}`;
  return new Date(iso);
}

function formatTime(d) {
  return d ? d.toLocaleTimeString([], {hour: "numeric", minute: "2-digit"}) : "";
}

function updateStatus(events) {
  const now = new Date();
  const todayEvents = events.filter(e => e.start && e.start.toDateString() === now.toDateString());
  const ongoing = todayEvents.find(e => now >= e.start && now < e.end);
  const statusEl = document.getElementById("status");

  if (ongoing) {
    statusEl.textContent = `üî¥ In Use ‚Äì ${ongoing.summary || "Meeting"} until ${formatTime(ongoing.end)}`;
    statusEl.className = "busy";
  } else {
    const next = todayEvents.find(e => e.start > now);
    statusEl.textContent = next
      ? `üü¢ Available until ${formatTime(next.start)}`
      : "üü¢ Available all day";
    statusEl.className = "available";
  }
}
loadICS();
setInterval(loadICS, 120000);
</script>
</body>
</html>
