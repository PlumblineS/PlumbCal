<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Centennial – South Conference Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body, html { height:100%; font-family: 'Segoe UI', sans-serif; color:#fff; overflow:hidden; }
        #background {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:url('images/calphoto4.jpg') center/cover no-repeat;
            filter: blur(3px) brightness(0.7);
            z-index:-2;
        }
        header, main, footer { position:relative; z-index:1; padding:1rem; }
        header { display:flex; justify-content:space-between; align-items:center; }
        .logo { height:50px; }
        #clock { font-size:4rem; text-align:center; margin:1rem 0; line-height:1.2; }
        #availability { font-size:1.5rem; text-align:center; margin:1rem 0; }
        .dot { display:inline-block; width:12px; height:12px; border-radius:50%; background:#0f0; margin-right:8px; vertical-align:middle; }
        #schedule { max-width:600px; margin:2rem auto; }
        .event { background:rgba(0,0,0,0.4); margin:0.5rem 0; padding:0.8rem; border-left:4px solid #ff9800; border-radius:4px; }
        .event time { font-weight:bold; }
        #upload { text-align:center; margin:2rem 0; }
        footer { text-align:center; font-size:0.9rem; opacity:0.8; position:absolute; bottom:10px; left:0; right:0; }
        
        /* Weather: Bottom Left */
        #weather {
            position: absolute;
            bottom: 60px;
            left: 20px;
            font-size: 1.1rem;
            background: rgba(0,0,0,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

<div id="background"></div>

<header>
    <h1>Centennial – South Conference Room</h1>
    <img src="images/plumbline-logo.png" alt="Plumbline" class="logo">
</header>

<main>
    <div id="clock"></div>
    <div id="availability"></div>
    <div id="schedule"></div>
    <div id="upload">
        <p>Upload ICS file for testing: <input type="file" id="icsFile" accept=".ics"></p>
    </div>
</main>

<div id="weather"></div>
<footer>Auto-refreshes every 2 minutes</footer>

<script>
/* ==============================================================
   CONFIG
   ============================================================== */
const ICS_URL = 'plumbline-south.ics';  // Must be in same folder

/* ==============================================================
   UTILS
   ============================================================== */
function pad(n){return n<10?'0'+n:n;}
function formatTime(d){
    const h = d.getHours() % 12 || 12;
    const m = pad(d.getMinutes());
    const ampm = d.getHours() < 12 ? 'AM' : 'PM';
    return `${h}:${m} ${ampm}`;
}
function formatDate(d){
    return d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
}

/* --------------------------------------------------------------
   CLOCK
   -------------------------------------------------------------- */
function updateClock(){
    const now = new Date();
    document.getElementById('clock').innerHTML = `
        <div style="font-size:4rem;">${formatTime(now)}</div>
        <div style="font-size:1.5rem;opacity:0.9;">${formatDate(now)}</div>
    `;
}
setInterval(updateClock, 1000);
updateClock();

/* --------------------------------------------------------------
   WEATHER (Bottom Left)
   -------------------------------------------------------------- */
document.getElementById('weather').innerHTML = `
    <div><strong>48°F in Centennial</strong></div>
    <div style="font-size:0.9rem;opacity:0.9;">
        Thu: 47°/26° • Fri: 60°/24° • Sat: 74°/46°
    </div>
`;

/* --------------------------------------------------------------
   ICS PARSING
   -------------------------------------------------------------- */
function parseICS(text){
    const events = [];
    const blocks = text.match(/BEGIN:VEVENT[\s\S]*?END:VEVENT/g) || [];
    
    blocks.forEach(block => {
        const ev = {};
        const lines = block.split(/\r?\n/).map(l => l.trim());
        
        lines.forEach(l => {
            if (l.startsWith('DTSTART')) {
                const val = l.split(':')[1,1];
                ev.start = parseDate(val);
            }
            if (l.startsWith('DTEND')) {
                const val = l.split(':')[1];
                ev.end = parseDate(val);
            }
            if (l.startsWith('SUMMARY')) {
                ev.title = l.split(':').slice(1).join(':').trim();
            }
            if (l.includes('VALUE=DATE')) ev.allDay = true;
        });
        
        if (ev.start && ev.title) events.push(ev);
    });
    return events;
}

function parseDate(str){
    str = str.replace(/[^0-9TZ]/g, '');
    if (!str) return null;
    
    if (str.length === 8) { // YYYYMMDD
        return new Date(str.slice(0,4), str.slice(4,6)-1, str.slice(6,8));
    }
    if (str.length >= 15 && str.endsWith('Z')) { // UTC
        return new Date(str);
    }
    if (str.length >= 14) { // Local: YYYYMMDDTHHMMSS
        return new Date(str.slice(0,4), str.slice(4,6)-1, str.slice(6,8),
                        str.slice(8,10), str.slice(10,12), str.slice(12,14));
    }
    return null;
}

/* --------------------------------------------------------------
   DISPLAY
   -------------------------------------------------------------- */
function displaySchedule(events){
    const sched = document.getElementById('schedule');
    sched.innerHTML = '';
    if (!events.length) {
        sched.innerHTML = '<p style="text-align:center;color:#aaa;font-style:italic;">No events today</p>';
        return;
    }
    events.sort((a,b) => a.start - b.start);
    events.forEach(ev => {
        const div = document.createElement('div');
        div.className = 'event';
        const start = formatTime(ev.start);
        const end = formatTime(ev.end || ev.start);
        div.innerHTML = `<time>${start} – ${end}</time>: ${ev.title}`;
        sched.appendChild(div);
    });
}

/* --------------------------------------------------------------
   AVAILABILITY
   -------------------------------------------------------------- */
function updateAvailability(events){
    const now = new Date();
    const upcoming = events.filter(e => e.start > now);
    const avail = document.getElementById('availability');
    
    if (!upcoming.length) {
        avail.innerHTML = '<span class="dot"></span> Available all day';
        return;
    }
    
    const next = upcoming[0];
    const until = formatTime(next.start);
    const title = next.title.split(' - ')[0]; // Clean title
    avail.innerHTML = `<span class="dot"></span> Available until ${until} (${title})`;
}

/* --------------------------------------------------------------
   LOAD ICS
   -------------------------------------------------------------- */
function loadICS(){
    fetch(ICS_URL)
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.text();
        })
        .then(text => {
            const allEvents = parseICS(text);
            const today = new Date();
            const todayEvents = allEvents.filter(e => {
                return e.start.getFullYear() === today.getFullYear() &&
                       e.start.getMonth() === today.getMonth() &&
                       e.start.getDate() === today.getDate();
            });
            
            displaySchedule(todayEvents);
            updateAvailability(allEvents);
        })
        .catch(err => {
            console.error('ICS load failed:', err);
            document.getElementById('schedule').innerHTML = 
                '<p style="color:#f88;text-align:center;">Failed to load calendar</p>';
        });
}

/* --------------------------------------------------------------
   TEST FILE UPLOAD
   -------------------------------------------------------------- */
document.getElementById('icsFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const allEvents = parseICS(ev.target.result);
        const today = new Date();
        const todayEvents = allEvents.filter(e => 
            e.start.getFullYear() === today.getFullYear() &&
            e.start.getMonth() === today.getMonth() &&
            e.start.getDate() === today.getDate()
        );
        displaySchedule(todayEvents);
        updateAvailability(allEvents);
    };
    reader.readAsText(file);
});

/* --------------------------------------------------------------
   AUTO-REFRESH
   -------------------------------------------------------------- */
loadICS();
setInterval(loadICS, 120000); // 2 minutes
</script>
</body>
</html>
