<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Centennial â€“ South Conference Room</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    .background {
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      transition: opacity 2s ease-in-out;
    }
    .fade {
      opacity: 0;
    }
    header {
      position: absolute;
      top: 20px;
      left: 30px;
      right: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 2;
    }
    header h1 {
      font-size: 1.6rem;
      color: #00539f;
      text-shadow: 0 0 8px rgba(0,0,0,0.4);
    }
    #logo {
      max-width: 170px;
      height: auto;
      opacity: 0.95;
    }
    .info {
      position: absolute;
      top: 120px;
      left: 30px;
      z-index: 2;
    }
    .clock {
      font-size: 4rem;
    }
    .date {
      font-size: 1.2rem;
      color: #f7b500;
      margin-bottom: 10px;
    }
    #status {
      font-size: 1.3rem;
      margin-top: 10px;
    }
    #status.available { color: #00c853; }
    #status.busy { color: #e53935; }
  </style>
</head>
<body>

  <div id="bg1" class="background"></div>
  <div id="bg2" class="background fade"></div>

  <header>
    <h1>Centennial â€“ South Conference Room</h1>
    <img id="logo" src="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha" alt="Logo">
  </header>

  <div class="info">
    <div class="clock" id="clock">--:--</div>
    <div class="date" id="date">Loading...</div>
    <div id="status">Loading schedule...</div>
  </div>

  <script>
    const IMAGES = [
      "images/calphoto1.jpg",
      "images/calphoto2.jpg",
      "images/calphoto3.jpg",
      "images/calphoto4.jpg",
      "images/calphoto5.jpg"
    ];
    const ICS_URL = "https://ics-proxy.highdefpants.workers.dev/?url=" + encodeURIComponent(
      "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/e8f33aaadcfb49e5b0a03df0bdb5e2c58129590484901015770/calendar.ics"
    );

    let currentBg = 0;
    const bg1 = document.getElementById("bg1");
    const bg2 = document.getElementById("bg2");
    bg1.style.backgroundImage = `url('${IMAGES[0]}')`;

    setInterval(() => {
      const next = (currentBg + 1) % IMAGES.length;
      const front = currentBg % 2 ? bg2 : bg1;
      const back = currentBg % 2 ? bg1 : bg2;
      back.style.backgroundImage = `url('${IMAGES[next]}')`;
      front.classList.add("fade");
      back.classList.remove("fade");
      currentBg = next;
    }, 15000);

    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent =
        now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      document.getElementById("date").textContent =
        now.toLocaleDateString([], { weekday: "long", month: "long", day: "numeric" });
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadICS() {
      try {
        const res = await fetch(ICS_URL);
        const text = await res.text();
        const unfolded = text.replace(/\r?\n[ \t]/g, "");
        const lines = unfolded.split(/\r?\n/);
        const events = [];
        let current = {};
        for (const line of lines) {
          if (line.startsWith("BEGIN:VEVENT")) current = {};
          else if (line.startsWith("SUMMARY:")) current.summary = line.slice(8).trim();
          else if (line.startsWith("DTSTART")) current.start = parseDate(line);
          else if (line.startsWith("DTEND")) current.end = parseDate(line);
          else if (line.startsWith("END:VEVENT")) events.push(current);
        }
        updateStatus(events);
      } catch (e) {
        document.getElementById("status").textContent = "Unable to load schedule";
      }
    }

    function parseDate(line) {
      const match = line.match(/(\d{8}T\d{6})(Z)?$/);
      if (!match) return null;
      const [_, dateStr, isZ] = match;
      const [year, month, day, hour, min, sec] = [
        dateStr.slice(0, 4), dateStr.slice(4, 6), dateStr.slice(6, 8),
        dateStr.slice(9, 11), dateStr.slice(11, 13), dateStr.slice(13, 15)
      ];
      const iso = `${year}-${month}-${day}T${hour}:${min}:${sec}${isZ ? "Z" : ""}`;
      return new Date(iso);
    }

    function updateStatus(events) {
      const now = new Date();
      const today = now.toDateString();
      const todayEvents = events.filter(e => e.start && e.start.toDateString() === today);
      const ongoing = todayEvents.find(e => now >= e.start && now < e.end);
      const statusEl = document.getElementById("status");

      if (ongoing) {
        statusEl.textContent = `ðŸ”´ In Use â€“ ${ongoing.summary} until ${formatTime(ongoing.end)}`;
        statusEl.className = "busy";
      } else {
        const next = todayEvents.find(e => e.start > now);
        statusEl.textContent = next
          ? `ðŸŸ¢ Available until ${formatTime(next.start)}`
          : "ðŸŸ¢ Available all day";
        statusEl.className = "available";
      }
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    }

    loadICS();
    setInterval(loadICS, 120000);
  </script>
</body>
</html>
