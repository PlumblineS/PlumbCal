<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plumbline â€“ South Conference Room</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: white;
        text-align: center;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: linear-gradient(
            rgba(0, 0, 0, 0.4),
            rgba(0, 0, 0, 0.7)
          ),
          url("https://images.unsplash.com/photo-1524758631624-e2822e304c36?auto=format&fit=crop&w=1920&q=80")
            center/cover no-repeat;
      }

      header {
        padding: 20px 0 0;
      }

      #logo {
        max-width: 280px;
        height: auto;
      }

      #time {
        font-size: 3.5em;
        font-weight: bold;
        margin-top: 15px;
      }

      #date {
        font-size: 1.3em;
        opacity: 0.9;
      }

      main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      #status {
        font-size: 2.6em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      #next {
        font-size: 1.4em;
        opacity: 0.95;
      }

      footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        padding: 20px;
        font-size: 1.2em;
      }

      #weather {
        text-align: left;
      }

      .forecast {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }

      .day {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.9em;
      }

      .day img {
        width: 40px;
        height: 40px;
      }

      #updated {
        font-size: 0.8em;
        opacity: 0.7;
        text-align: right;
      }
    </style>
  </head>

  <body>
    <header>
      <img
        id="logo"
        src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Plumbline_Services_logo.png"
        alt="Plumbline Logo"
      />
      <div id="time"></div>
      <div id="date"></div>
    </header>

    <main>
      <div id="status">Loading schedule...</div>
      <div id="next"></div>
    </main>

    <footer>
      <div id="weather">
        <div id="current"></div>
        <div class="forecast" id="forecast"></div>
      </div>
      <div id="updated"></div>
    </footer>

    <script>
      const tz = "America/Denver";

      /* ---------- CLOCK ---------- */
      function updateTime() {
        const now = new Date();
        document.getElementById("time").textContent = now.toLocaleTimeString(
          "en-US",
          { hour: "2-digit", minute: "2-digit", hour12: true, timeZone: tz }
        );
        document.getElementById("date").textContent = now.toLocaleDateString(
          "en-US",
          { weekday: "long", month: "long", day: "numeric", timeZone: tz }
        );
      }
      setInterval(updateTime, 1000);
      updateTime();

      /* ---------- CALENDAR ---------- */
      const ICS_URL =
        "https://corsproxy.io/?" +
        encodeURIComponent(
          "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/e8f33aaadcfb49e5b0a03df0bdb5e2c58129590484901015770/calendar.ics"
        );

      async function loadCalendar() {
        try {
          const res = await fetch(ICS_URL, { cache: "no-store" });
          const text = await res.text();

          // Join folded lines (lines starting with space)
          const clean = text.replace(/\r?\n[ \t]/g, "");

          const blocks = clean.split("BEGIN:VEVENT").slice(1);
          const events = [];
          for (const b of blocks) {
            const summary = (b.match(/SUMMARY:(.*)/) || [])[1];
            const start = (b.match(/DTSTART[^:]*:(.*)/) || [])[1];
            const end = (b.match(/DTEND[^:]*:(.*)/) || [])[1];
            if (summary && start && end) {
              const startDate = parseICSDate(start);
              const endDate = parseICSDate(end);
              if (startDate && endDate)
                events.push({ summary: summary.trim(), start: startDate, end: endDate });
            }
          }

          const now = new Date();
          const current = events.find((e) => now >= e.start && now <= e.end);
          const next = events
            .filter((e) => e.start > now)
            .sort((a, b) => a.start - b.start)[0];

          const status = document.getElementById("status");
          const nextEl = document.getElementById("next");

          if (current) {
            status.textContent = "ðŸ”´ In Use";
            nextEl.textContent = `${current.summary} until ${formatTime(current.end)}`;
          } else if (next) {
            status.textContent = "ðŸŸ¢ Available";
            nextEl.textContent = `Until ${formatTime(next.start)} â€“ Next: ${next.summary}`;
          } else {
            status.textContent = "ðŸŸ¢ Available all day";
            nextEl.textContent = "";
          }

          document.getElementById("updated").textContent =
            "Updated " +
            new Date().toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });
        } catch (e) {
          console.error("Calendar error:", e);
          document.getElementById("status").textContent = "Error loading calendar";
        }
      }

      function parseICSDate(str) {
        try {
          if (str.includes("T")) {
            const [d, t] = str.split("T");
            return new Date(
              `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)}T${t.slice(
                0,
                2
              )}:${t.slice(2, 4)}:00-07:00`
            );
          } else return new Date(`${str.slice(0, 4)}-${str.slice(4, 6)}-${str.slice(6, 8)}`);
        } catch {
          return null;
        }
      }

      function formatTime(d) {
        return d.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
          timeZone: tz,
        });
      }

      loadCalendar();
      setInterval(loadCalendar, 120000);

      /* ---------- WEATHER ---------- */
      const WEATHER_URL =
        "https://api.open-meteo.com/v1/forecast?latitude=39.58&longitude=-104.83&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&temperature_unit=fahrenheit";

      async function loadWeather() {
        try {
          const res = await fetch(WEATHER_URL);
          const data = await res.json();

          const temp = Math.round(data.current.temperature_2m);
          const icon = iconForWeather(data.current.weather_code);
          document.getElementById(
            "current"
          ).innerHTML = `<img src="${icon}" alt=""> ${temp}Â°F`;

          const fc = document.getElementById("forecast");
          fc.innerHTML = "";
          for (let i = 1; i <= 3; i++) {
            const dayName = new Date(data.daily.time[i]).toLocaleDateString("en-US", {
              weekday: "short",
            });
            const icon2 = iconForWeather(data.daily.weather_code[i]);
            const max = Math.round(data.daily.temperature_2m_max[i]);
            fc.innerHTML += `<div class="day"><div>${dayName}</div><img src="${icon2}" alt=""><div>${max}Â°</div></div>`;
          }
        } catch (e) {
          console.error("Weather error:", e);
        }
      }

      function iconForWeather(code) {
        if ([0, 1].includes(code))
          return "https://openweathermap.org/img/wn/01d.png";
        if ([2, 3].includes(code))
          return "https://openweathermap.org/img/wn/02d.png";
        if ([45, 48].includes(code))
          return "https://openweathermap.org/img/wn/50d.png";
        if ([51, 53, 55, 61, 63, 65].includes(code))
          return "https://openweathermap.org/img/wn/09d.png";
        if ([71, 73, 75].includes(code))
          return "https://openweathermap.org/img/wn/13d.png";
        if ([95, 96, 99].includes(code))
          return "https://openweathermap.org/img/wn/11d.png";
        return "https://openweathermap.org/img/wn/04d.png";
      }

      loadWeather();
      setInterval(loadWeather, 600000);
    </script>
  </body>
</html>
