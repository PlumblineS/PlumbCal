<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>South Conference Room</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body, html {
    height: 100%;
    overflow: hidden;
    font-family: system-ui, -apple-system, sans-serif;
    color: #fff;
  }

  /* Background slideshow container */
  .bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    transition: opacity 2s ease-in-out;
    z-index: -2;
  }

  /* Overlay for better text readability */
  .overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.45);
    z-index: -1;
  }

  header {
    text-align: center;
    padding: 24px 10px 8px;
    font-size: 2rem;
    font-weight: 600;
  }

  .status {
    text-align: center;
    margin: 10px 0 20px;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .status.free { color: #4caf50; }
  .status.busy { color: #ff5252; }

  .event {
    margin: 12px auto;
    max-width: 600px;
    background: rgba(255, 255, 255, 0.12);
    border-radius: 10px;
    padding: 12px 16px;
    backdrop-filter: blur(6px);
  }

  .event .time {
    font-weight: bold;
    font-size: 1.2rem;
  }

  .event .title {
    margin-top: 4px;
    font-size: 1.1rem;
  }

  footer {
    position: fixed;
    bottom: 10px;
    width: 100%;
    text-align: center;
    font-size: 0.8rem;
    color: #ccc;
  }
</style>
</head>

<body>
<div id="bg1" class="bg"></div>
<div id="bg2" class="bg" style="opacity: 0;"></div>
<div class="overlay"></div>

<header>South Conference Room</header>
<div id="status" class="status">Loading schedule...</div>
<div id="events"></div>

<footer>Auto-refreshes every 5 minutes</footer>

<script>
const ICS_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(
  "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/11007c9e19554a799267ce38e79446506920446490200924026/calendar.ics";
const images = [
  "images/calphoto1.jpg",
  "images/calphoto2.jpg",
  "images/calphoto3.jpg",
  "images/calphoto4.jpg",
  "images/calphoto5.jpg"
];

// ---------- Background fade rotation ----------
let current = 0;
const bg1 = document.getElementById("bg1");
const bg2 = document.getElementById("bg2");
bg1.style.backgroundImage = `url(${images[0]})`;

setInterval(() => {
  const next = (current + 1) % images.length;
  bg2.style.backgroundImage = `url(${images[next]})`;
  bg2.style.opacity = 1;
  setTimeout(() => {
    bg1.style.backgroundImage = bg2.style.backgroundImage;
    bg2.style.opacity = 0;
    current = next;
  }, 2000);
}, 15000); // 15 seconds per image

// ---------- Calendar logic ----------
async function loadICS() {
  try {
    const res = await fetch(ICS_URL);
    const text = await res.text();
    parseICS(text);
  } catch {
    document.getElementById("status").textContent = "Unable to load calendar.";
  }
}

function parseICS(data) {
  const events = [];
  const lines = data.split(/\r?\n/);
  let current = {};
  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) current = {};
    else if (line.startsWith("END:VEVENT")) {
      if (current.start && current.end && current.summary)
        events.push(current);
    } else if (line.startsWith("DTSTART")) {
      current.start = parseICSTime(line.split(":")[1]);
    } else if (line.startsWith("DTEND")) {
      current.end = parseICSTime(line.split(":")[1]);
    } else if (line.startsWith("SUMMARY")) {
      current.summary = line.split(":")[1];
    }
  }

  events.sort((a,b)=>a.start-b.start);
  const now = new Date();
  const today = events.filter(e => e.start.toDateString() === now.toDateString());
  const container = document.getElementById("events");
  container.innerHTML = "";

  if (!today.length) {
    document.getElementById("status").textContent = "ðŸŸ¢ Available all day";
    document.getElementById("status").className = "status free";
    return;
  }

  let isBusy = false;
  let next = null;

  for (const e of today) {
    const startStr = e.start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const endStr = e.end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML = `<div class="time">${startStr}â€“${endStr}</div>
                     <div class="title">${e.summary}</div>`;
    container.appendChild(div);
    if (now >= e.start && now <= e.end) isBusy = true;
    if (now < e.start && !next) next = e;
  }

  const status = document.getElementById("status");
  if (isBusy) {
    status.textContent = "ðŸ”´ In Use";
    status.className = "status busy";
  } else {
    if (next) {
      const startStr = next.start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      status.textContent = `ðŸŸ¢ Available until ${startStr}`;
    } else {
      status.textContent = "ðŸŸ¢ Available for the rest of the day";
    }
    status.className = "status free";
  }
}

function parseICSTime(val) {
  const year = parseInt(val.slice(0,4));
  const month = parseInt(val.slice(4,6)) - 1;
  const day = parseInt(val.slice(6,8));
  const hour = parseInt(val.slice(9,11));
  const minute = parseInt(val.slice(11,13));
  return new Date(Date.UTC(year, month, day, hour, minute));
}

loadICS();
setInterval(loadICS, 300000); // 5 min refresh
</script>
</body>
</html>

