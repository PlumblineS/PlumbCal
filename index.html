<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Centennial â€“ South Conference Room</title>
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    color: #ffffff;
    overflow: hidden;
  }

  .background {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    transition: opacity 2s ease-in-out;
  }

  .overlay {
    position: relative;
    z-index: 2;
    text-align: center;
    padding-top: 40px;
    backdrop-filter: blur(6px) brightness(0.9);
    background: rgba(0, 0, 0, 0.25);
  }

  h1 {
    color: #00539f; /* Plumbline blue */
    font-size: 2rem;
    margin-bottom: 0.5em;
  }

  #status {
    font-size: 1.2rem;
    font-weight: bold;
    color: #f7b500; /* Gold accent */
  }

  #status.available { color: #00c853; }
  #status.busy { color: #e53935; }

  #events {
    margin-top: 1em;
    padding: 1em;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    background: rgba(0, 0, 0, 0.35);
    border-radius: 10px;
  }

  #logo {
    position: absolute;
    top: 15px;
    right: 20px;
    width: 170px;
    opacity: 0.95;
  }

  .fade {
    opacity: 0;
  }
</style>
</head>
<body>
  <div id="bg1" class="background"></div>
  <div id="bg2" class="background fade"></div>

  <div class="overlay">
    <img id="logo" src="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha" alt="Plumbline Logo" />
    <h1>Centennial â€“ South Conference Room</h1>
    <div id="status">Loading schedule...</div>
    <div id="events"></div>
  </div>

<script>
const ICS_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(
  "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/11007c9e19554a799267ce38e79446506920446490200924026/calendar.ics"
);

const images = [
  "images/calphoto1.jpg",
  "images/calphoto2.jpg",
  "images/calphoto3.jpg",
  "images/calphoto4.jpg",
  "images/calphoto5.jpg"
];

let currentBg = 0;
const bg1 = document.getElementById("bg1");
const bg2 = document.getElementById("bg2");

function cycleBackground() {
  const next = (currentBg + 1) % images.length;
  const front = currentBg % 2 ? bg2 : bg1;
  const back = currentBg % 2 ? bg1 : bg2;
  back.style.backgroundImage = `url('${images[next]}')`;
  front.classList.add("fade");
  back.classList.remove("fade");
  currentBg = next;
}
bg1.style.backgroundImage = `url('${images[0]}')`;
setInterval(cycleBackground, 15000); // 15 sec per image

async function loadICS() {
  try {
    const res = await fetch(ICS_URL);
    const text = await res.text();
    const now = new Date();
    const events = [];
    const lines = text.split(/\r?\n/);

    let current = {};
    for (let line of lines) {
      if (line.startsWith("BEGIN:VEVENT")) current = {};
      if (line.startsWith("SUMMARY:")) current.summary = line.replace("SUMMARY:", "").trim();
      if (line.startsWith("DTSTART")) current.start = parseDate(line);
      if (line.startsWith("DTEND")) current.end = parseDate(line);
      if (line.startsWith("END:VEVENT")) events.push(current);
    }

    const todayEvents = events.filter(e =>
      e.start && e.start.toDateString() === now.toDateString()
    ).sort((a,b) => a.start - b.start);

    const ongoing = todayEvents.find(e => now >= e.start && now < e.end);
    const statusEl = document.getElementById("status");
    const eventsEl = document.getElementById("events");

    if (ongoing) {
      statusEl.textContent = "ðŸ”´ In Use until " + formatTime(ongoing.end);
      statusEl.className = "busy";
    } else {
      statusEl.textContent = todayEvents.length ? "ðŸŸ¢ Available between meetings" : "ðŸŸ¢ Available all day";
      statusEl.className = "available";
    }

    eventsEl.innerHTML = todayEvents.map(e =>
      `<div><strong>${formatTime(e.start)} â€“ ${formatTime(e.end)}</strong><br>${e.summary || "Untitled meeting"}</div>`
    ).join("<hr style='border: 0; height: 1px; background: rgba(255,255,255,0.2); margin: 8px 0;'>");
  } catch (err) {
    document.getElementById("status").textContent = "Unable to load calendar";
  }
}

function parseDate(line) {
  const m = line.match(/:(\d{8}T\d{6})/);
  return m ? new Date(
    m[1].replace(
      /(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/,
      "$1-$2-$3T$4:$5:$6"
    )
  ) : null;
}

function formatTime(d) {
  return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}

loadICS();
setInterval(loadICS, 300000); // 5 min refresh
</script>
</body>
</html>
