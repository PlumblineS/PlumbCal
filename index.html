<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Centennial â€“ South Conference Room</title>
<style>
Â  html,body{margin:0;padding:0;font-family:"Segoe UI",sans-serif;color:#fff;overflow:hidden;background:#000;}
Â  .background{position:fixed;inset:0;background-size:cover;background-position:center;transition:opacity 2s ease-in-out;}
Â  .fade{opacity:0;}
Â  header{position:absolute;top:10px;left:30px;right:30px;display:flex;justify-content:space-between;align-items:center;z-index:3;}
Â  header h1{font-size:1.6rem;font-weight:600;color:#00539f;text-shadow:0 0 8px rgba(0,0,0,.4);}
Â  #logo{max-width:170px;height:auto;opacity:.95;flex-shrink:0;}
Â  main{position:relative;display:flex;height:100vh;z-index:2;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);}
Â  .left{flex:0 0 32%;padding:90px 30px 30px;display:flex;flex-direction:column;align-items:flex-start;}
Â  .clock{font-size:4rem;font-weight:600;line-height:1;}
Â  .date{font-size:1.2rem;margin-bottom:20px;color:#f7b500;}
Â  #status{font-size:1.1rem;font-weight:500;margin:10px 0 25px;}
Â  #status.available{color:#00c853;}#status.busy{color:#e53935;}
Â  .weather{margin-top:auto;font-size:1rem;}
Â  .temp{font-size:2rem;font-weight:600;}
Â  .forecast{display:flex;gap:12px;margin-top:12px;font-size:.85rem;}
Â  .forecast div{text-align:center;}
Â  .right{flex:1;padding:90px 30px 30px;display:flex;justify-content:center;align-items:center;}
Â  .calendar{width:90%;max-width:900px;background:rgba(0,0,0,.45);border-radius:12px;padding:20px;backdrop-filter:blur(5px);}
Â  .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;color:#f7b500;font-weight:600;}
Â  .grid{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:110px;gap:2px;}
Â  .day{position:relative;background:rgba(255,255,255,.05);border-radius:6px;padding:6px;overflow:hidden;}
Â  .day .date-num{font-size:.9rem;opacity:.9;}
Â  .today{outline:2px solid #f7b500;}
Â  .event{position:absolute;left:4px;right:4px;height:12px;border-radius:3px;background:#00539f;opacity:.85;margin-top:4px;}
Â  .event:hover::after{content:attr(data-title);position:absolute;bottom:16px;left:0;right:0;background:rgba(0,0,0,.8);color:#fff;padding:4px 6px;border-radius:4px;font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
Â  #noEvents{text-align:center;color:#ccc;margin-top:20px;}
</style>
</head>
<body>
<div id="bg1" class="background"></div>
<div id="bg2" class="background fade"></div>

<header>
Â  <h1>Centennial â€“ South Conference Room</h1>
Â  <img id="logo" src="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha" alt="Plumbline Logo">
</header>

<main>
Â  <section class="left">
Â  Â  <div class="clock" id="clock">--:--</div>
Â  Â  <div class="date" id="date">Loading...</div>
Â  Â  <div id="status">Loading schedule...</div>
Â  Â  <div class="weather" id="weather">
Â  Â  Â  <div class="temp" id="temp">--Â°F</div>
Â  Â  Â  <div id="conditions"></div>
Â  Â  Â  <div class="forecast" id="forecast"></div>
Â  Â  </div>
Â  </section>

Â  <section class="right">
Â  Â  <div class="calendar">
Â  Â  Â  <div class="cal-header" id="calHeader"></div>
Â  Â  Â  <div class="grid" id="calendarGrid"></div>
Â  Â  Â  <div id="noEvents"></div>
Â  Â  </div>
Â  </section>
</main>

<script>
/* ---------- CONFIG ---------- */
const IMAGES=[
Â "images/calphoto1.jpg","images/calphoto2.jpg","images/calphoto3.jpg",
Â "images/calphoto4.jpg","images/calphoto5.jpg"
];
// NOTE: ICS_URL with allorigins.win is used as a CORS proxy. If calendar fails, this URL or your public ICS link is likely the issue.
const ICS_URL="https://api.allorigins.win/raw?url="+encodeURIComponent(
Â "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/11007c9e19554d984e75751c99096d/calendar.ics"
);
const LAT=39.5807, LON=-104.8772;

/* ---------- BACKGROUND FADE ---------- */
let currentBg=0;
const bg1=document.getElementById("bg1"),bg2=document.getElementById("bg2");
bg1.style.backgroundImage=`url('${IMAGES[0]}')`;
setInterval(()=>{
Â const next=(currentBg+1)%IMAGES.length;
Â const front=currentBg%2?bg2:bg1;
Â const back=currentBg%2?bg1:bg2;
Â back.style.backgroundImage=`url('${IMAGES[next]}')`;
Â front.classList.add("fade"); back.classList.remove("fade");
Â currentBg=next;
},15000);

/* ---------- CLOCK & DATE ---------- */
function updateClock(){
Â const now=new Date();
Â document.getElementById("clock").textContent=
Â  Â now.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
Â document.getElementById("date").textContent=
Â  Â now.toLocaleDateString([], {weekday:"long",month:"long",day:"numeric"});
}
setInterval(updateClock,1000); updateClock();

/* ---------- WEATHER ---------- */
async function loadWeather(){
Â try{
Â  Â const url=`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&temperature_unit=fahrenheit&current=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&forecast_days=4&timezone=auto`;
Â  Â const res=await fetch(url);
Â  Â const data=await res.json();
Â  Â const codes={0:"â˜€ï¸",1:"ğŸŒ¤",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",61:"ğŸŒ§",71:"â„ï¸",80:"ğŸŒ§",95:"â›ˆ"};
Â  Â document.getElementById("temp").textContent=Math.round(data.current.temperature_2m)+"Â°F";
Â  Â document.getElementById("conditions").textContent=codes[data.current.weathercode]||"";
Â  Â const fc=document.getElementById("forecast"); fc.innerHTML="";
Â  Â for(let i=1;i<data.daily.time.length;i++){
Â  Â  Â const d=new Date(data.daily.time[i]);
Â  Â  Â fc.innerHTML+=`<div>${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]}<br>${codes[data.daily.weathercode[i]]||""}<br><small>${Math.round(data.daily.temperature_2m_max[i])}Â°/${Math.round(data.daily.temperature_2m_min[i])}Â°</small></div>`;
Â  Â }
Â }catch(e){console.log("Weather error",e);}
}
loadWeather(); setInterval(loadWeather,1800000);

/* ---------- CALENDAR ---------- */
async function loadICS(){
Â try{
Â  Â const res=await fetch(ICS_URL);
Â  Â const text=await res.text();
Â  Â // unfold wrapped lines (Outlook wraps long lines with a space)
Â  Â const unfolded=text.replace(/\r?\n[ \t]/g,"");
Â  Â const lines=unfolded.split(/\r?\n/);
Â  Â const events=[];
Â  Â let current={};
Â  Â for(const line of lines){
Â  Â  Â if(line.startsWith("BEGIN:VEVENT")) current={};
Â  Â  Â else if(line.startsWith("SUMMARY:")) current.summary=line.slice(8).trim();
Â  Â  Â else if(line.startsWith("DTSTART")) current.start=parseDate(line);
Â  Â  Â else if(line.startsWith("DTEND")) current.end=parseDate(line);
Â  Â  Â else if(line.startsWith("END:VEVENT")) events.push(current);
Â  Â }
Â  Â renderCalendar(events);
Â  Â updateStatus(events);
Â }catch(e){document.getElementById("status").textContent="Unable to load calendar";}
}

// **FIXED: Improved regex to handle TZID and UTC (Z) in iCalendar DTSTART/DTEND lines.**
function parseDate(line){
  // Look for the date/time string (YYYYMMDDTHHMMSS) after the last colon, optionally followed by 'Z' (for UTC).
  const match = line.match(/(\d{8}T\d{6})(Z)?$/); 
  if(!match) return null;
  
  const dateStr = match[1];
  const isUtc = !!match[2]; // Check if 'Z' is present
  
  const year=dateStr.substr(0,4),mon=dateStr.substr(4,2),day=dateStr.substr(6,2);
  const hour=dateStr.substr(9,2),min=dateStr.substr(11,2),sec=dateStr.substr(13,2);
  
  // Construct the ISO string. New Date() will correctly handle UTC 'Z' or local time.
  const isoStr = `${year}-${mon}-${day}T${hour}:${min}:${sec}${isUtc ? 'Z' : ''}`;
  
  return new Date(isoStr);
}

function renderCalendar(events){
Â const now=new Date(),year=now.getFullYear(),month=now.getMonth();
Â const firstDay=new Date(year,month,1);
Â const startDay=firstDay.getDay();
Â const daysInMonth=new Date(year,month+1,0).getDate();
Â document.getElementById("calHeader").textContent=
Â  Â now.toLocaleDateString([], {month:"long",year:"numeric"});
Â const grid=document.getElementById("calendarGrid");
Â grid.innerHTML="";
Â for(let i=0;i<startDay;i++) grid.innerHTML+="<div></div>";
Â let hasEvents=false;
Â for(let d=1;d<=daysInMonth;d++){
Â  Â const cell=document.createElement("div"); cell.className="day";
Â  Â const date=new Date(year,month,d);
Â  Â if(date.toDateString()===now.toDateString()) cell.classList.add("today");
Â  Â cell.innerHTML=`<div class="date-num">${d}</div>`;
    
    // **IMPROVED: Filter for events that overlap with the current day**
    const dayEnd = new Date(year, month, d, 23, 59, 59); // End of the current day
    const dayStart = new Date(year, month, d, 0, 0, 0);   // Start of the current day

    const dayEvents = events.filter(e => {
        // Event starts before the end of the day AND ends after the start of the day
        return e.start && e.end && e.start < dayEnd && e.end > dayStart;
    });
    
Â  Â if(dayEvents.length>0) hasEvents=true;
Â  Â dayEvents.forEach((ev,idx)=>{
Â  Â  Â const el=document.createElement("div");
Â  Â  Â el.className="event";
Â  Â  Â el.style.top=(20+idx*14)+"px";
Â  Â  Â el.dataset.title=`${ev.summary||"Untitled"} (${formatTime(ev.start)}â€“${formatTime(ev.end)})`;
Â  Â  Â cell.appendChild(el);
Â  Â });
Â  Â grid.appendChild(cell);
Â }
Â document.getElementById("noEvents").textContent=hasEvents?"":"No scheduled meetings.";
}

function updateStatus(events){
Â const now=new Date();
Â const todayEvents=events.filter(e=>e.start&&e.start.toDateString()===now.toDateString());
Â const ongoing=todayEvents.find(e=>now>=e.start&&now<e.end);
Â const statusEl=document.getElementById("status");
Â if(ongoing){
Â  Â statusEl.textContent="ğŸ”´ In Use â€“ "+(ongoing.summary||"Meeting")+" until "+formatTime(ongoing.end);
Â  Â statusEl.className="busy";
Â }else{
Â  Â const next=todayEvents.find(e=>e.start>now);
Â  Â statusEl.textContent=next?"ğŸŸ¢ Available until "+formatTime(next.start):"ğŸŸ¢ Available all day";
Â  Â statusEl.className="available";
Â }
}
function formatTime(d){return d?d.toLocaleTimeString([], {hour:"numeric",minute:"2-digit"}):"";}
loadICS(); setInterval(loadICS,120000);
</script>
</body>
</html>
