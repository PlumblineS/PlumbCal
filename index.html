<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Centennial â€“ South Conference Room</title>

<!-- Full-screen iPad support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="South Conference Room">
<link rel="apple-touch-icon" href="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha">

<style>
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    color: #fff;
    background-color: #000;
    height: 100vh;
    overflow: hidden;
  }

  .background {
    position: fixed;
    inset: 0;
    background-size: cover;
    background-position: center;
    transition: background-image 2s ease-in-out;
    z-index: -1;
    filter: brightness(0.85);
  }

  header {
    position: absolute;
    top: 20px;
    left: 30px;
    right: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.35);
    padding: 10px 20px;
    border-radius: 10px;
    backdrop-filter: blur(4px);
  }

  h1 {
    margin: 0;
    font-size: 1.6rem;
    color: #f7b500;
  }

  .logo {
    height: 50px;
  }

  main {
    position: absolute;
    top: 55%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    backdrop-filter: blur(5px);
    background: rgba(0, 0, 0, 0.25);
    padding: 25px 60px;
    border-radius: 20px;
    width: 80%;
    max-width: 700px;
  }

  #time {
    position: absolute;
    top: 90px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 3.5rem;
    font-weight: 600;
  }

  #date {
    position: absolute;
    top: 160px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.3rem;
    opacity: 0.9;
  }

  #status {
    font-size: 2rem;
    font-weight: 600;
    margin-top: 40px;
  }

  .available { color: #00ff88; }
  .busy { color: #ff4c4c; }

  #weather-widget {
    position: absolute;
    bottom: 20px;
    left: 20px;
    text-align: left;
    font-size: 1.1rem;
    opacity: 0.95;
    background: rgba(0,0,0,0.3);
    padding: 10px 15px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
  }

  #weather-current {
    font-size: 1.3rem;
    margin-bottom: 8px;
  }

  #forecast {
    font-size: 1rem;
    line-height: 1.4em;
  }

  footer {
    position: absolute;
    bottom: 20px;
    right: 25px;
    font-size: 1rem;
    opacity: 0.6;
  }
</style>
</head>
<body>
  <div class="background" id="background"></div>

  <header>
    <h1>Centennial â€“ South Conference Room</h1>
    <img class="logo"
      src="https://wg.scene7.com/is/image/wrenchgroup/updated-2023-logo-pl23wi001wg?fmt=png-alpha"
      alt="Plumbline Logo" />
  </header>

  <div id="time">--:--</div>
  <div id="date">Loading...</div>

  <main>
    <div id="status" class="available">Loading schedule...</div>
  </main>

  <div id="weather-widget">
    <div id="weather-current">ðŸŒ¤ Loading...</div>
    <div id="forecast"></div>
  </div>

  <footer>Auto-refreshes every 2 minutes</footer>

<script>
/* ---------- CONFIG ---------- */
const IMAGES = [
  "images/calphoto1.jpg",
  "images/calphoto2.jpg",
  "images/calphoto3.jpg",
  "images/calphoto4.jpg",
  "images/calphoto5.jpg"
];
const ICS_URL =
  "https://api.allorigins.win/raw?url=" +
  encodeURIComponent(
    "https://outlook.office365.com/owa/calendar/73ff77286546455d984e75751c99096d@plumblineservices.com/e8f33aaadcfb49e5b0a03df0bdb5e2c58129590484901015770/calendar.ics"
  );
const LAT = 39.5807, LON = -104.8772;

/* ---------- BACKGROUND ROTATION ---------- */
let currentImage = 0;
function changeBackground() {
  document.getElementById("background").style.backgroundImage = `url('${IMAGES[currentImage]}')`;
  currentImage = (currentImage + 1) % IMAGES.length;
}
changeBackground();
setInterval(changeBackground, 15000);

/* ---------- CLOCK ---------- */
function updateClock() {
  const now = new Date();
  document.getElementById("time").textContent = now.toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
  document.getElementById("date").textContent = now.toLocaleDateString([], {weekday: "long", month: "long", day: "numeric"});
}
updateClock();
setInterval(updateClock, 1000);

/* ---------- WEATHER + FORECAST ---------- */
async function loadWeather() {
  try {
    const res = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&temperature_unit=fahrenheit&current=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`
    );
    const data = await res.json();
    const codes = {0:"â˜€ï¸",1:"ðŸŒ¤",2:"â›…",3:"â˜ï¸",45:"ðŸŒ«",48:"ðŸŒ«",51:"ðŸŒ¦",61:"ðŸŒ§",71:"â„ï¸",80:"ðŸŒ§",95:"â›ˆ"};
    const temp = Math.round(data.current.temperature_2m);
    const icon = codes[data.current.weathercode] || "ðŸŒ¤";
    document.getElementById("weather-current").textContent = `${icon} ${temp}Â°F`;

    const forecast = data.daily.time.slice(1, 4).map((date, i) => {
      const code = data.daily.weathercode[i + 1];
      const hi = Math.round(data.daily.temperature_2m_max[i + 1]);
      const lo = Math.round(data.daily.temperature_2m_min[i + 1]);
      const day = new Date(date).toLocaleDateString([], {weekday: "short"});
      return `${day}: ${(codes[code] || "ðŸŒ¤")} ${hi}Â° / ${lo}Â°`;
    });
    document.getElementById("forecast").innerHTML = forecast.join("<br>");
  } catch {
    document.getElementById("weather-current").textContent = "Weather unavailable";
  }
}
loadWeather();
setInterval(loadWeather, 900000);

/* ---------- CALENDAR STATUS ---------- */
async function loadICS() {
  try {
    const res = await fetch(ICS_URL);
    const text = await res.text();
    const events = parseICS(text);
    updateStatus(events);
  } catch {
    document.getElementById("status").textContent = "Unable to load calendar";
  }
}

function parseDate(line) {
  // Supports both TZID=America/Denver and UTC (Z)
  const match = line.match(/:(\d{8}T\d{6})(Z)?/);
  if (!match) return null;
  const dateStr = match[1];
  const isUtc = !!match[2];
  const year = dateStr.substr(0,4), mon = dateStr.substr(4,2), day = dateStr.substr(6,2);
  const hour = dateStr.substr(9,2), min = dateStr.substr(11,2), sec = dateStr.substr(13,2);
  const iso = `${year}-${mon}-${day}T${hour}:${min}:${sec}${isUtc ? "Z" : ""}`;
  return new Date(iso);
}

function parseICS(text) {
  const lines = text.split(/\r?\n/);
  const events = [];
  let current = {};
  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) current = {};
    else if (line.startsWith("END:VEVENT")) events.push(current);
    else if (line.startsWith("DTSTART")) current.start = parseDate(line);
    else if (line.startsWith("DTEND")) current.end = parseDate(line);
    else if (line.startsWith("SUMMARY")) current.summary = line.split(":").slice(1).join(":");
  }
  return events;
}

function updateStatus(events) {
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
  const todayEvents = events.filter(e => e.start && e.start < todayEnd && e.end > todayStart);
  const current = todayEvents.find(e => now >= e.start && now < e.end);
  const statusEl = document.getElementById("status");

  if (current) {
    statusEl.textContent = `ðŸ”´ In Use â€“ ${current.summary || "Meeting"} until ${formatTime(current.end)}`;
    statusEl.className = "busy";
  } else {
    const next = todayEvents.find(e => e.start > now);
    statusEl.textContent = next
      ? `ðŸŸ¢ Available until ${formatTime(next.start)} (${next.summary})`
      : "ðŸŸ¢ Available all day";
    statusEl.className = "available";
  }
}

function formatTime(date) {
  return date ? date.toLocaleTimeString([], {hour: "numeric", minute: "2-digit"}) : "";
}

loadICS();
setInterval(loadICS, 120000);
</script>
</body>
</html>

